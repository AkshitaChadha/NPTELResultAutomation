<!DOCTYPE html>
<html>
<head>
<title>Login</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<style>
.alert {
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 6px;
    font-weight: 500;
    text-align: center;
}

.alert-danger {
    background-color: #fdecea;
    color: #c0392b;
    border: 1px solid #c0392b;
}
</style>

</head>
<body>

<div class="navbar">
    <h3>NPTEL Result System</h3>
</div>

<div class="container" style="max-width:500px; margin-top:60px;">

    <h2 class="page-title" style="text-align:center;">Login</h2>

    <!-- ðŸ”´ ERROR MESSAGE -->
    {% if error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
    {% endif %}

    <form method="POST" style="margin-top:30px;">

        <!-- EMAIL -->
        <input name="email"
               id="email"
               placeholder="Enter Email"
               required
               value="{{ email }}"
               class="big-input">

        <br>

        <!-- PASSWORD -->
        <input name="password"
               type="password"
               placeholder="Enter Password"
               required
               class="big-input">

        <br>

        <!-- ROLE DROPDOWN -->
        <select name="role"
                id="roleSelect"
                class="big-input">
        </select>

        <br>

        <button class="primary-btn" style="width:100%;">
            Login
        </button>

    </form>

</div>

<script>

function loadRoles(email, selectedRole=null) {

    if (!email) return;

    fetch("/check_roles?email=" + email)
    .then(response => response.json())
    .then(data => {

        let select = document.getElementById("roleSelect");
        select.innerHTML = "";

        // ðŸ”´ Real HOD (Super Admin)
        if (data.roles.includes("HOD")) {

            let superOption = document.createElement("option");
            superOption.value = "ADMIN";
            superOption.text = "Super Admin";
            select.appendChild(superOption);

            select.value = "ADMIN";
            return;
        }

        // ðŸŸ¢ Teacher option
        if (data.roles.includes("TEACHER")) {
            let teacherOption = document.createElement("option");
            teacherOption.value = "TEACHER";
            teacherOption.text = "Teacher";
            select.appendChild(teacherOption);
        }

        // ðŸŸ¡ Admin option (promoted teacher)
        if (data.roles.includes("ADMIN")) {
            let adminOption = document.createElement("option");
            adminOption.value = "ADMIN";
            adminOption.text = "Admin";
            select.appendChild(adminOption);
        }

        // ðŸ”¥ Restore previously selected role
        if (selectedRole) {
            select.value = selectedRole;
        }

    });
}

// ðŸ”µ On email blur â†’ load roles
document.getElementById("email").addEventListener("blur", function() {
    loadRoles(this.value);
});

// ðŸ”¥ AUTO LOAD ROLES ON PAGE LOAD (after invalid login)
window.onload = function() {

    let existingEmail = "{{ email }}";
    let previousRole = "{{ selected_role }}";

    if (existingEmail) {
        loadRoles(existingEmail, previousRole);
    }
};

</script>

</body>
</html>