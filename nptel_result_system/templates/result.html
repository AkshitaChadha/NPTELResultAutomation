<!DOCTYPE html>
<html>
<head>
<title>Final Results</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <input type="hidden" name="subject_id" value="{{ session.get('active_subject') }}">

<div class="navbar">
    <h3>NPTEL Result System</h3>

    <div class="nav-actions">
        {% if session.get("role") == "TEACHER" %}
        <a href="/teacher_dashboard">
            <button class="secondary-btn">Dashboard</button>
        </a>
        {% elif session.get("role") == "HOD" %}
        <a href="/hod_dashboard">
            <button class="secondary-btn">Dashboard</button>
        </a>
        {% endif %}

        <a href="/logout">
            <button class="primary-btn">Logout</button>
        </a>
    </div>
</div>

<div class="container">

<h2 class="page-title">Final Evaluation</h2>

{% if data|length > 0 %}

<div style="display:flex; gap:15px; margin-bottom:20px;">

<!-- Download Button -->
{% if can_download %}

    <a href="/download_pdf/{{ evaluation_id }}">
        <button class="primary-btn">
            Download Final Result
        </button>
    </a>

{% else %}

    <button class="primary-btn"
            style="background:#bdc3c7;
                   opacity:0.6;
                   cursor:not-allowed;"
            disabled>
        Download Final Result
    </button>

{% endif %}



    
    {% if session.get("role") == "TEACHER" and stage == "college_done" %}

    {% if not evaluation_locked %}
        <form method="POST" action="/lock_marks">
            <button class="danger-btn"
                    onclick="return confirm('Once locked, marks cannot be changed. Continue?')">
                Lock Marks
            </button>
        </form>
    {% else %}
        <button class="secondary-btn" disabled>
            ðŸ”’ Locked
        </button>
    {% endif %}

{% endif %}




    

</div>

<table class="styled-table">
<tr>
<th>Roll</th>
<th>Name</th>
<th>NPTEL Assignment</th>
<th>College Internal</th>
<th>NPTEL Exam</th>
<th>College External</th>
<th>Total</th>
<th>Result</th>
<th>Track</th>
</tr>

{% for row in data %}
<tr>
<td>{{ row["University Roll Number"] }}</td>
<td>{{ row["Student Name"] }}</td>
<td>{{ row["Assignment Marks"] }}</td>
<td>{{ row.get("Internal_Final","-") }}</td>
<td>{{ row["NPTEL External Marks"] }}</td>
<td>{{ row.get("External_Final","-") }}</td>
<td>{{ row.get("Total","-") }}</td>
<td>{{ row.get("Result","-") }}</td>
<td>{{ row.get("Track","-") }}</td>
</tr>
{% endfor %}

</table>

{% else %}
<p>No data available.</p>
{% endif %}


<!-- Show College Section ONLY if pending -->

{% if college_list|length > 0 %}

<br><br>


<h3>College Exam Students</h3>

<table class="styled-table">
<tr>
<th>Roll</th>
<th>Name</th>
<th>Status</th>
</tr>

{% for row in college_list %}
<tr>
<td>{{ row["University Roll Number"] }}</td>
<td>{{ row["Student Name"] }}</td>
<td>{{ row["Result"] }}</td>
</tr>
{% endfor %}
</table>

{% endif %}

<!-- Update Button (ALWAYS AVAILABLE) -->
 <br>
 <br>
    {% if session.get("role") == "TEACHER"
      and stage == "college_pending"
      and not evaluation_locked %}

    <a href="/edit_college_marks">
        <button class="primary-btn">
            Update College Marks
        </button>
    </a>

{% endif %}

    
   {% if not evaluation_locked %}

    <button class="secondary-btn" onclick="openDownloadModal()">
        Download College Exam List
    </button>

{% endif %}

<!-- Modal -->
<div id="downloadModal" class="modal">
  <div class="modal-content" style="text-align:center; width:320px;">

    <h3 style="margin-bottom:25px;">Select Download Format</h3>

    <div style="
        display:flex;
        flex-direction:column;
        gap:15px;
        margin-bottom:20px;
    ">

      <a href="/download_college_excel" style="width:100%;">
          <button class="primary-btn" style="width:100%;">
              Download as Excel
          </button>
      </a>

      <a href="/download_college_pdf" style="width:100%;">
          <button class="primary-btn" style="width:100%;">
              Download as PDF
          </button>
      </a>

      <a href="/download_attendance_sheet" style="width:100%;">
          <button class="primary-btn" style="width:100%;">
              Download Attendance Sheet
          </button>
      </a>

    </div>

    <button class="secondary-btn"
            style="width:100%;"
            onclick="closeDownloadModal()">
        Cancel
    </button>

  </div>
</div>


<script>
function openDownloadModal() {
    document.getElementById("downloadModal").style.display = "flex";
}

function closeDownloadModal() {
    document.getElementById("downloadModal").style.display = "none";
}
</script>


<br><br>

<div style="text-align:center;">
<a href="{{ '/teacher_dashboard' if session.get('role') == 'TEACHER' else '/hod_dashboard' }}">
<button class="secondary-btn">â¬… Back to Dashboard</button>
</a>
</div>

</div>
</body>
</html>
